import { S3Client, PutObjectCommand, GetObjectCommand } from '@aws-sdk/client-s3';
import { getSignedUrl } from '@aws-sdk/s3-request-presigner';
import dotenv from 'dotenv';
import { Booking } from '../models/booking/bookingModel';
import { Response,Request } from 'express';
import { CustomRequest } from '../middlewares/authMiddleWare';
dotenv.config();

const s3 = new S3Client({
  region: process.env.AWS_REGION,
  credentials: {
    accessKeyId: process.env.AWS_ACCESS_KEY_ID!,
    secretAccessKey: process.env.AWS_SECRET_ACCESS_KEY!,
  },
});

export const generatePresignedUrl = async (fileName: string, fileType: string) => {
  console.log('ffjjifjij');
  const key = `car-images/${Date.now()}-${fileName}`;

  const command = new PutObjectCommand({
    Bucket: process.env.AWS_S3_BUCKET_NAME!,
    Key: key,
    ContentType: fileType,
  });

  const url = await getSignedUrl(s3, command, { expiresIn: 3600 });
  return { url, key };
};


export const generateViewPresignedUrl = async (key: string) => {
  
  const command = new GetObjectCommand({
    Bucket: process.env.AWS_S3_BUCKET_NAME!,
    Key: key,
  });

  const url = await getSignedUrl(s3, command, {
    expiresIn: 60,
  });

  return { url };
};


export const generateViewRecieptPresignedUrl = async (
  key: string,
  expiresIn = 60
): Promise<string> => {
  const command = new GetObjectCommand({
    Bucket: process.env.AWS_S3_BUCKET_NAME!,
    Key: key,
  });

  return getSignedUrl(s3, command, { expiresIn });
};


// export const getReceiptViewUrl = async (req: Request, res: Response) => {
//   const booking = await Booking.findById(req.params.bookingId);

//   if (!booking?.receiptKey) {
//     res.status(404).json({ message: "Receipt not found" });
//     return
//   }

//   // âœ… permission check
//   if (booking.userId.toString() !== req.userId) {
//     return res.status(403).json({ message: "Forbidden" });
//   }

//   const command = new GetObjectCommand({
//     Bucket: process.env.AWS_S3_BUCKET_NAME!,
//     Key: booking.receiptKey,
//   });

//   const url = await getSignedUrl(s3, command, {
//     expiresIn: 60,
//   });

//   res.json({ url });
// };
